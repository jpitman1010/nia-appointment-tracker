<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Appointment Calendar - NIA Appointment Tracker</title>

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" />

  <!-- Bootstrap CSS -->
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet" />

  <!-- FullCalendar CSS -->
  <link href="{{ url_for('static', filename='js/fullcalendar/core/main.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/fullcalendar/daygrid/main.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/fullcalendar/timegrid/main.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='js/fullcalendar/list/main.min.css') }}" rel="stylesheet" />

  <!-- Your custom CSS -->
  <link href="{{ url_for('static', filename='css/calendar.css') }}" rel="stylesheet" />
  <style>
    /* Patient search dropdown fix */
    #patientResults {
      z-index: 1050;
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      width: 100%;
      display: none;
      background: white;
      border: 1px solid #ccc;
      border-radius: 0 0 .25rem .25rem;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h1>Appointment Calendar</h1>
    <button id="scheduleAppointmentModalBtn" class="btn btn-primary mb-3">Schedule Appointment</button>

    <div id="calendar"></div>

    <!-- Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <form id="appointmentForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="appointmentModalLabel">Schedule Appointment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">

            <input type="hidden" id="appointmentId" />

            <!-- Patient Search -->
            <div class="mb-3 position-relative">
              <label for="patientSearch" class="form-label">Search Patient</label>
              <input type="text" id="patientSearch" class="form-control" autocomplete="off"
                placeholder="Search patient by MRN, Name or Greek Name" />
              <div id="patientResults" class="list-group"></div>
              <input type="hidden" id="patientId" />
            </div>

            <!-- Provider Dropdown -->
            <div class="mb-3">
              <label for="providerSelect" class="form-label">Provider</label>
              <select id="providerSelect" class="form-select" required>
                <option value="">Select a provider</option>
                <!-- Providers loaded dynamically -->
              </select>
            </div>

            <div class="mb-3">
              <label for="startTime" class="form-label">Start Time</label>
              <input type="datetime-local" class="form-control" id="startTime" required />
            </div>

            <div class="mb-3">
              <label for="endTime" class="form-label">End Time</label>
              <input type="datetime-local" class="form-control" id="endTime" required />
            </div>

            <div id="errorMsg" class="text-danger mb-3" style="display:none;"></div>

          </div>
          <div class="modal-footer">
            <button type="submit" id="saveBtn" class="btn btn-primary">Save</button>
            <button type="button" id="deleteBtn" class="btn btn-danger" style="display:none;">Delete</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- Bootstrap Bundle JS (includes Popper) -->
  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

  <!-- FullCalendar global bundles -->
  <script src="{{ url_for('static', filename='js/fullcalendar/core/index.global.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/fullcalendar/daygrid/index.global.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/fullcalendar/timegrid/index.global.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/fullcalendar/list/index.global.min.js') }}"></script>

  <script>
    async function loadProviders() {
      try {
        const response = await fetch( '/api/providers' );
        if ( !response.ok ) throw new Error( 'Failed to load providers' );
        const providers = await response.json();

        const providerSelect = document.getElementById( 'providerSelect' );
        providerSelect.innerHTML = '<option value="">Select a provider</option>';

        providers.forEach( provider => {
          const opt = document.createElement( 'option' );
          opt.value = provider.id;
          opt.textContent = `${provider.fname} ${provider.lname}`;
          providerSelect.appendChild( opt );
        } );
      } catch ( err ) {
        console.error( err );
      }
    }

    function setupPatientSearch() {
      const input = document.getElementById( 'patientSearch' );
      const results = document.getElementById( 'patientResults' );
      const hiddenInput = document.getElementById( 'patientId' );

      input.addEventListener( 'input', async () => {
        const query = input.value.trim();
        hiddenInput.value = ''; // clear selected patient if input changes

        if ( !query ) {
          results.style.display = 'none';
          results.innerHTML = '';
          return;
        }

        try {
          // Adjust the query params based on your backend API
          const url =
            `/api/patients?fname=${encodeURIComponent(query)}&lname=${encodeURIComponent(query)}&mrn=${encodeURIComponent(query)}`;
          const response = await fetch( url );
          if ( !response.ok ) throw new Error( 'Network error' );

          const data = await response.json();

          if ( !data.length ) {
            results.style.display = 'none';
            results.innerHTML = '';
            return;
          }

          // Build list buttons for results
          results.innerHTML = data.map( p => `
        <button type="button" class="list-group-item list-group-item-action" data-id="${p.id}">
          ${p.mrn ? `[${p.mrn}] ` : ''}${p.fname} ${p.lname} ${p.greek_fname ? `(${p.greek_fname})` : ''}
        </button>
      ` ).join( '' );
          results.style.display = 'block';

          // Add click event to each button to select patient
          results.querySelectorAll( 'button' ).forEach( btn => {
            btn.addEventListener( 'click', () => {
              input.value = btn.textContent.trim();
              hiddenInput.value = btn.getAttribute( 'data-id' );
              results.style.display = 'none';
            } );
          } );

        } catch ( error ) {
          console.error( error );
          results.style.display = 'none';
          results.innerHTML = '';
        }
      } );

      // Close dropdown if clicked outside
      document.addEventListener( 'click', ( e ) => {
        if ( !results.contains( e.target ) && e.target !== input ) {
          results.style.display = 'none';
        }
      } );
    }

    // Call this setup function inside your window.onload
    window.onload = function () {
      // ... your existing initialization code ...
      setupPatientSearch();
      // ... rest of your code ...
    };


    window.onload = function () {
      loadProviders();
      setupPatientSearch();

      const calendarEl = document.getElementById( 'calendar' );
      if ( !calendarEl ) {
        console.error( 'Calendar container not found!' );
        return;
      }

      let appointmentModal;

      function getModal() {
        if ( !appointmentModal ) {
          appointmentModal = new bootstrap.Modal( document.getElementById( 'appointmentModal' ) );
        }
        return appointmentModal;
      }

      const appointmentForm = document.getElementById( 'appointmentForm' );
      const errorMsg = document.getElementById( 'errorMsg' );
      const deleteBtn = document.getElementById( 'deleteBtn' );

      const appointmentIdInput = document.getElementById( 'appointmentId' );
      const patientIdInput = document.getElementById( 'patientId' );
      const providerIdInput = document.getElementById( 'providerSelect' );
      const startTimeInput = document.getElementById( 'startTime' );
      const endTimeInput = document.getElementById( 'endTime' );

      window.calendar = new FullCalendar.Calendar( calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        slotDuration: '00:30:00',
        slotLabelInterval: '00:30:00',
        slotMinTime: '07:00:00',
        slotMaxTime: '19:00:00',
        nowIndicator: true,
        editable: false,
        selectable: true,
        selectMirror: true,
        events: fetchAppointments,

        select: function ( info ) {
          clearForm();
          appointmentIdInput.value = '';
          patientIdInput.value = '';
          providerIdInput.value = '';
          startTimeInput.value = info.startStr.slice( 0, 16 );
          endTimeInput.value = info.endStr.slice( 0, 16 );
          deleteBtn.style.display = 'none';
          errorMsg.classList.add( 'd-none' );
          getModal().show();
        },

        eventClick: function ( info ) {
          clearForm();
          const event = info.event;
          appointmentIdInput.value = event.id;
          patientIdInput.value = event.extendedProps.patient_id || '';
          providerIdInput.value = event.extendedProps.provider_id || '';
          startTimeInput.value = event.startStr.slice( 0, 16 );
          endTimeInput.value = event.endStr.slice( 0, 16 );
          deleteBtn.style.display = 'inline-block';
          errorMsg.classList.add( 'd-none' );
          getModal().show();
        }
      } );

      calendar.render();

      document.querySelectorAll( 'a[data-bs-toggle="tab"]' ).forEach( tab => {
        tab.addEventListener( 'shown.bs.tab', function ( event ) {
          const targetTab = event.target.getAttribute( 'href' );
          if ( targetTab === '#calendar-tab' || targetTab === '#calendar' ) {
            if ( window.calendar ) {
              window.calendar.updateSize();
            }
          }
        } );
      } );

      async function fetchAppointments( fetchInfo, successCallback, failureCallback ) {
        try {
          const url = `/api/appointments?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`;
          const response = await fetch( url );
          if ( !response.ok ) throw new Error( 'Network response was not ok' );
          const data = await response.json();

          const events = data.map( appt => ( {
            id: appt.id.toString(),
            title: `${appt.patient_name} - ${appt.provider_name}`,
            start: appt.start_time,
            end: appt.end_time,
            extendedProps: {
              patient_id: appt.patient_id,
              provider_id: appt.provider_id
            }
          } ) );

          successCallback( events );
        } catch ( error ) {
          console.error( 'Failed to fetch appointments:', error );
          failureCallback( error );
        }
      }

      function clearForm() {
        errorMsg.classList.add( 'd-none' );
        errorMsg.textContent = '';
        appointmentForm.reset();
      }

      appointmentForm.addEventListener( 'submit', async function ( e ) {
        e.preventDefault();
        errorMsg.classList.add( 'd-none' );

        const id = appointmentIdInput.value;
        const payload = {
          patient_id: patientIdInput.value.trim(),
          provider_id: providerIdInput.value.trim(),
          start_time: startTimeInput.value,
          end_time: endTimeInput.value
        };

        if ( !payload.patient_id || !payload.provider_id || !payload.start_time || !payload.end_time ) {
          errorMsg.textContent = 'All fields are required.';
          errorMsg.classList.remove( 'd-none' );
          return;
        }

        try {
          let url = '/api/appointments';
          let method = 'POST';
          if ( id ) {
            url += `/${id}`;
            method = 'PUT';
          }

          const response = await fetch( url, {
            method,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify( payload )
          } );

          const result = await response.json();

          if ( !response.ok ) {
            errorMsg.textContent = result.error || 'Failed to save appointment.';
            errorMsg.classList.remove( 'd-none' );
            return;
          }

          getModal().hide();
          calendar.refetchEvents();

        } catch ( error ) {
          errorMsg.textContent = 'Network error. Please try again.';
          errorMsg.classList.remove( 'd-none' );
          console.error( error );
        }
      } );

      deleteBtn.addEventListener( 'click', async function () {
        const id = appointmentIdInput.value;
        if ( !id ) return;

        if ( !confirm( 'Are you sure you want to delete this appointment?' ) ) return;

        try {
          const response = await fetch( `/api/appointments/${id}`, {
            method: 'DELETE'
          } );
          const result = await response.json();

          if ( result.success ) {
            getModal().hide();
            calendar.refetchEvents();
          } else {
            errorMsg.textContent = 'Failed to delete appointment.';
            errorMsg.classList.remove( 'd-none' );
          }
        } catch ( error ) {
          errorMsg.textContent = 'Network error. Please try again.';
          errorMsg.classList.remove( 'd-none' );
          console.error( error );
        }
      } );
      document.getElementById( 'scheduleAppointmentModalBtn' ).addEventListener( 'click', () => {
        getModal().show();
      } );
    };
  </script>
</body>

</html>